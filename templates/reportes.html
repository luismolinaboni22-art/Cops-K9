@app.route("/reportes", methods=["GET"])
def reportes():

    # Obtener filtros del formulario
    tipo = request.args.get("tipo", "todos")
    fecha = request.args.get("fecha", "")
    nombre = request.args.get("nombre", "").lower()
    empresa = request.args.get("empresa", "").lower()
    cedula = request.args.get("cedula", "").lower()
    responsable = request.args.get("responsable", "").lower()

    # Consolidar data en una sola lista
    data = []

    # --- Visitantes ---
    if tipo in ["visitantes", "todos"]:
        for v in VISITORS:
            data.append({
                "tipo": "Visitante",
                "nombre": v["nombre"],
                "cedula": v["cedula"],
                "empresa": v["empresa"],
                "responsable": v["responsable"],
                "motivo": v.get("motivo"),
                "placa": v.get("placa"),
                "ingreso": v["hora_ingreso"],
                "salida": v["hora_salida"]
            })

    # --- Contratistas ---
    if tipo in ["contratistas", "todos"]:
        for c in CONTRACTORS:
            data.append({
                "tipo": "Contratista",
                "nombre": c["nombre"],
                "cedula": c["cedula"],
                "empresa": c["empresa"],
                "responsable": c["responsable"],
                "motivo": "-",
                "placa": "-",
                "ingreso": c["hora_ingreso"],
                "salida": c["hora_salida"]
            })

    # --- Proveedores ---
    if tipo in ["proveedores", "todos"]:
        for p in PROVIDERS:
            data.append({
                "tipo": "Proveedor",
                "nombre": p["nombre"],
                "cedula": p["cedula"],
                "empresa": p["empresa"],
                "responsable": p["responsable"],
                "motivo": p.get("motivo"),
                "placa": "-",
                "ingreso": p["hora_ingreso"],
                "salida": p["hora_salida"]
            })

    # ----------------------------------
    #          APLICAR FILTROS
    # ----------------------------------

    # FILTRO POR FECHA
    if fecha.strip() != "":
        data = [x for x in data if x["ingreso"].startswith(fecha)]

    # FILTRO POR NOMBRE
    if nombre.strip() != "":
        data = [x for x in data if nombre in x["nombre"].lower()]

    # FILTRO POR EMPRESA
    if empresa.strip() != "":
        data = [x for x in data if empresa in x["empresa"].lower()]

    # FILTRO POR CÃ‰DULA
    if cedula.strip() != "":
        data = [x for x in data if cedula in x["cedula"].lower()]

    # FILTRO POR RESPONSABLE
    if responsable.strip() != "":
        data = [x for x in data if responsable in x["responsable"].lower()]

    # Enviar los datos filtrados a la plantilla
    return render_template(
        "reportes.html",
        registros=data,
        filtro_tipo=tipo,
        filtro_fecha=fecha,
        filtro_nombre=nombre,
        filtro_empresa=empresa,
        filtro_cedula=cedula,
        filtro_responsable=responsable
    )
